(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{155:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return c})),a.d(t,"metadata",(function(){return i})),a.d(t,"rightToc",(function(){return b})),a.d(t,"default",(function(){return p}));var n=a(2),r=a(9),l=(a(0),a(161)),c={id:"authorization_code",title:"Authorization code grant"},i={id:"api/oauth2/authorization_code",title:"Authorization code grant",description:'The Authorization code grant is the most commonly used (think about the "Login with Facebook/Google" buttons). It explicitly asks the user the permission to give access to its data to the client app.',source:"@site/docs/api/oauth2/authorization_code.md",permalink:"/nestjs-oauth2/docs/api/oauth2/authorization_code",sidebar:"api",previous:{title:"Scopes",permalink:"/nestjs-oauth2/docs/api/scopes"},next:{title:"Client credentials grant",permalink:"/nestjs-oauth2/docs/api/oauth2/client_credentials"}},b=[{value:"Authorization flow",id:"authorization-flow",children:[]},{value:"Request payload",id:"request-payload",children:[{value:"Payload description",id:"payload-description",children:[]}]},{value:"Response payload",id:"response-payload",children:[]},{value:"PKCE (Proof Key for Code Exchange) extension",id:"pkce-proof-key-for-code-exchange-extension",children:[]}],o={rightToc:b};function p(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(l.b)("wrapper",Object(n.a)({},o,a,{components:t,mdxType:"MDXLayout"}),Object(l.b)("p",null,'The Authorization code grant is the most commonly used (think about the "Login with Facebook/Google" buttons). It explicitly asks the user the permission to give access to its data to the client app.'),Object(l.b)("h2",{id:"authorization-flow"},"Authorization flow"),Object(l.b)("p",null,"To start an authorization flow, the client must redirect the user to the auth server ",Object(l.b)("inlineCode",{parentName:"p"},"/oauth2/authorize")," endpoint passing the required configuration as query string:"),Object(l.b)("table",null,Object(l.b)("thead",{parentName:"table"},Object(l.b)("tr",{parentName:"thead"},Object(l.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Name"),Object(l.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Required"),Object(l.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Default"),Object(l.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Description"))),Object(l.b)("tbody",{parentName:"table"},Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"response_type"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"true"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"null"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Must be set as ",Object(l.b)("inlineCode",{parentName:"td"},"code"))),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"client_id"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"true"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"null"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Client id that is requesting access")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"state"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"true"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"null"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"String that can have a meaning for the client")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"scope"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"false"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"null"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Optional comma separated list of scopes to apply")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"redirect_uri"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"true"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"null"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Specify to which redirect url redirect the user")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"response_type"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"false"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"code"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Specify what kind of response the client expects")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"response_mode"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"false"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"query"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Specify how the client expect the response")))),Object(l.b)("p",null,"The Server will authenticate the user and, if the client is not flagged as first party, ask him to explicitly authorize the client application to access its data"),Object(l.b)("p",null,"If the user authorize it, the server will generate an Authorization Code and redirect the user to the redirect_uri passing ",Object(l.b)("inlineCode",{parentName:"p"},"code=GENERATED_AUTH_CODE")," as query string"),Object(l.b)("p",null,"The authorization code can only be used by this client, expires fast, and only to retrieve an access_token (the authorization code does not authenticate the user, but only 'authorize' the client to authenticate on behalf of the user)."),Object(l.b)("p",null,"The Client then retrieve the token"),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Endpoint"),": ",Object(l.b)("inlineCode",{parentName:"p"},"/oauth2/token")),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Method"),": ",Object(l.b)("inlineCode",{parentName:"p"},"POST")),Object(l.b)("h2",{id:"request-payload"},"Request payload"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-json"}),'{\n  "client_id": "c02d5bf5-993e-4c6a-a248-6c307cc7681b",\n  "client_secret": "c5bb2489292fac7711baedd65d87296261d08cdbdde2073c9fdb29941ac5446a",\n  "code": "code-retrieved-from-querystring",\n  "grant_type": "authorization_code",\n  "redirect_uri": "exmaple.com/cb",\n  "scope": "read:something list:something"\n}\n')),Object(l.b)("h3",{id:"payload-description"},"Payload description"),Object(l.b)("table",null,Object(l.b)("thead",{parentName:"table"},Object(l.b)("tr",{parentName:"thead"},Object(l.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Name"),Object(l.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Required"),Object(l.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Default"),Object(l.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Description"))),Object(l.b)("tbody",{parentName:"table"},Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"grant_type"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"true"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"null"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Must be set as ",Object(l.b)("inlineCode",{parentName:"td"},"authorization_code"))),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"client_id"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"true"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"null"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Client id that is requesting access")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"client_secret"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"true"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"null"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Client secret that is requesting access")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"code"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"true"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"null"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Authorization code from querystring")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"redirect_uri"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"true"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"null"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Same redirect uri as the /authorize redirect")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"scope"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"false"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"null"),Object(l.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Optional space separated list of scopes to apply, should match the ones used in the /authorize")))),Object(l.b)("h2",{id:"response-payload"},"Response payload"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-json"}),'{\n  "access_token": "JWT TOKEN"\n}\n')),Object(l.b)("h2",{id:"pkce-proof-key-for-code-exchange-extension"},"PKCE (Proof Key for Code Exchange) extension"),Object(l.b)("p",null,"If a ",Object(l.b)("strong",{parentName:"p"},"Public")," client (authMethds: ","['none']",") is trying to use this grant it MUST implement the PKCE extension."),Object(l.b)("p",null,"Before redirecting to authorize endpoint, the client generates a random string and its sha256 hash, persisting the random string in some way (to be used in the callback)."),Object(l.b)("p",null,"To the ",Object(l.b)("inlineCode",{parentName:"p"},"/oauth/authorize")," redirect, the client will pass a ",Object(l.b)("inlineCode",{parentName:"p"},"code_challenge")," param with the base64 url safe of the generated hash and a ",Object(l.b)("inlineCode",{parentName:"p"},"code_challenge_method")," param with value ",Object(l.b)("inlineCode",{parentName:"p"},"SHA-256")),Object(l.b)("p",null,"When the client asks for a token using the Authorization code, it will pass a ",Object(l.b)("inlineCode",{parentName:"p"},"code_verifier")," param with the plain random string generated at the previous step."),Object(l.b)("p",null,"The server will generate the sha256 of the passed ",Object(l.b)("inlineCode",{parentName:"p"},"code_verifier")," and compare its base64 with the ",Object(l.b)("inlineCode",{parentName:"p"},"code_challenge")," passed before.   "))}p.isMDXComponent=!0},161:function(e,t,a){"use strict";a.d(t,"a",(function(){return u})),a.d(t,"b",(function(){return O}));var n=a(0),r=a.n(n);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function c(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?c(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):c(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function b(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var o=r.a.createContext({}),p=function(e){var t=r.a.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=p(e.components);return r.a.createElement(o.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},s=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,l=e.originalType,c=e.parentName,o=b(e,["components","mdxType","originalType","parentName"]),u=p(a),s=n,O=u["".concat(c,".").concat(s)]||u[s]||d[s]||l;return a?r.a.createElement(O,i(i({ref:t},o),{},{components:a})):r.a.createElement(O,i({ref:t},o))}));function O(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var l=a.length,c=new Array(l);c[0]=s;var i={};for(var b in t)hasOwnProperty.call(t,b)&&(i[b]=t[b]);i.originalType=e,i.mdxType="string"==typeof e?e:n,c[1]=i;for(var o=2;o<l;o++)c[o]=a[o];return r.a.createElement.apply(null,c)}return r.a.createElement.apply(null,a)}s.displayName="MDXCreateElement"}}]);